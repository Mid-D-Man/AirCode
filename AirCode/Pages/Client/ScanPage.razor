@page "/Client/ScanAttendance"
@layout AirCode.Layout.ClientLayout.ClientLayout
@using AirCode.Components.SharedPrefabs.Scanner
@using AirCode.Models.Supabase
@using AirCode.Services.Auth
@using AirCode.Services.Courses
@using AirCode.Services.SupaBase
<NavigationLock ConfirmExternalNavigation="false" OnBeforeInternalNavigation="@OnBeforeInternalNavigation"></NavigationLock>

<div class="scan-page">
    <!-- Header -->
    <header class="scan-header">
        <h3>Scan QR Code</h3>
        <p>Scan the attendance QR code to mark your presence</p>
    </header>

    <!-- Main Scanner Area -->
    <main class="scanner-main">
        <div class="video-container">
            <video id="qrScanner" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: contain; border-radius: 20px;"></video>
            
            <!-- Scan overlay frame -->
            <div class="scan-overlay">
                <div class="scan-frame">
                    <div class="frame-corners">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                    </div>
                    @if (isScanning && !isProcessing)
                    {
                        <div class="scan-line"></div>
                    }
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message @(isSuccess ? "success" : "error")">
                <span class="status-icon">@(isSuccess ? "‚úÖ" : "‚ö†Ô∏è")</span>
                <span>@statusMessage</span>
                <button class="close-btn" @onclick="ClearStatus">√ó</button>
            </div>
        }

        <!-- Processing State -->
        @if (isProcessing)
        {
            <div class="processing-state">
                <div class="spinner"></div>
                <span>Processing QR Code...</span>
            </div>
        }
    </main>

    <!-- Controls -->
    <footer class="scan-controls">
        @if (isScanning)
        {
            <button class="control-btn stop" @onclick="StopScanning" disabled="@isProcessing">
                <span class="icon">‚è∏</span>
                Stop Scanner
            </button>
        }
        else
        {
            <button class="control-btn start" @onclick="StartScanning">
                <span class="icon">‚ñ∂</span>
                Start Scanner
            </button>
        }
        
        @if (isScanning)
        {
            <button class="control-btn camera" @onclick="SwitchCamera">
                <span class="icon">üîÑ</span>
                Switch Camera
            </button>
        }
    </footer>
</div>