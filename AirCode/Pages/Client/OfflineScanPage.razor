@page "/Client/OfflineScanPage"
@inject IJSRuntime JSRuntime
@using AirCode.Layout.FullScreen
@using AirCode.Models.Supabase
@using AirCode.Services.SupaBase
@using ReactorBlazorQRCodeScanner
@using AirCode.Utilities.HelperScripts
@using AirCode.Services.Attendance
@inject QRCodeDecoder QRDecoder
@inject IOfflineSyncService OfflineSyncService
@layout FullScreenLayout

<div class="offline-scan-page">
    <div class="scan-header">
        <h3>Smart Attendance Scan</h3>
        <p>Scan QR codes for automatic online/offline attendance recording</p>
        <div class="status-indicators">
            <div class="connection-indicator @(isOnline ? "online" : "offline")">
                <span class="status-icon">@(isOnline ? "üåê" : "üì¥")</span>
                <span class="status-text">@(isOnline ? "Online" : "Offline") Mode</span>
            </div>
        </div>
    </div>
    
    <div class="scan-container @(isProcessing ? "processing" : "") @(scanComplete ? "scan-complete" : "")">
        <div class="qr-scanner-container">
            <QRCodeScanner ShowOutput="false" Width="100%" />
        </div>

        <!-- Scan frame overlay -->
        <div class="scan-frame">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
            <div class="scan-line"></div>
        </div>

        <!-- Processing overlay -->
        @if (isProcessing)
        {
            <div class="processing-overlay">
                <div class="spinner"></div>
                <span>Processing QR Code...</span>
            </div>
        }

        <!-- Result overlay -->
        @if (showResult && !isProcessing)
        {
            <div class="result-overlay @(resultSuccess ? "success" : "error")">
                <div class="result-icon">
                    @if (resultSuccess)
                    {
                        <span class="success-icon">‚úì</span>
                    }
                    else
                    {
                        <span class="error-icon">‚úó</span>
                    }
                </div>
                <div class="result-message">@((MarkupString)resultMessage)</div>
                <button class="continue-btn" @onclick="ContinueScanning">Continue Scanning</button>
            </div>
        }

        <div class="scan-controls">
            @if (isScanning)
            {
                <button class="control-btn" @onclick="StopScanning">
                    <span class="btn-icon">‚è∏</span>
                    Stop Scanner
                </button>
            }
            else
            {
                <button class="control-btn" @onclick="StartScanning">
                    <span class="btn-icon">‚ñ∂</span>
                    Start Scanner
                </button>
            }
        </div>

        <!-- Smart sync status panel -->
        <div class="sync-status-panel @(isOnline ? "online-mode" : "offline-mode")">
            <div class="status-header">
                <span class="status-icon">@(isOnline ? "‚ö°" : "üíæ")</span>
                <span>@(isOnline ? "Sync Status" : "Offline Records")</span>
            </div>
            
            <div class="status-info">
                @if (isOnline)
                {
                    <div class="status-item">
                        <span class="label">Connection:</span>
                        <span class="value online-text">‚úÖ Online</span>
                    </div>
                }
                else
                {
                    <div class="status-item">
                        <span class="label">Connection:</span>
                        <span class="value offline-text">üì¥ Offline</span>
                    </div>
                }
                
                <div class="status-item">
                    <span class="label">Pending Records:</span>
                    <span class="value @(pendingRecordsCount > 0 ? "has-pending" : "")">@pendingRecordsCount</span>
                </div>
                
                @if (lastSyncTime.HasValue)
                {
                    <div class="status-item">
                        <span class="label">Last Activity:</span>
                        <span class="value">@lastSyncTime.Value.ToString("HH:mm")</span>
                    </div>
                }
            </div>
            
            @if (pendingRecordsCount > 0 && isOnline)
            {
                <button class="sync-btn" @onclick="TrySync" disabled="@isSyncing">
                    @if (isSyncing)
                    {
                        <span class="spinner-small"></span>
                        <span>Syncing...</span>
                    }
                    else
                    {
                        <span>üîÑ Sync Now</span>
                    }
                </button>
            }
            else if (pendingRecordsCount > 0 && !isOnline)
            {
                <div class="sync-info">
                    <span class="info-icon">‚ÑπÔ∏è</span>
                    <span>Records will sync automatically when online</span>
                </div>
            }
            else if (pendingRecordsCount == 0 && isOnline)
            {
                <div class="sync-info success">
                    <span class="info-icon">‚úÖ</span>
                    <span>All records synced</span>
                </div>
            }
        </div>
    </div>
</div>