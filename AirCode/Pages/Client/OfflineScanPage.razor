@page "/Client/OfflineScanPage"
@inject IJSRuntime JSRuntime
@using AirCode.Layout.FullScreen
@using AirCode.Models.Supabase
@using AirCode.Services.SupaBase
@using AirCode.Components.SharedPrefabs.Scanner
@using AirCode.Components.SharedPrefabs.Cards
@using AirCode.Utilities.HelperScripts
@using AirCode.Services.Attendance
@using AirCode.Domain.Enums
@inject QRCodeDecoder QRDecoder
@inject IOfflineSyncService OfflineSyncService
@inject ConnectivityService ConnectivityService
@layout FullScreenLayout

<NavigationLock ConfirmExternalNavigation="false" OnBeforeInternalNavigation="@OnBeforeInternalNavigation"></NavigationLock>

<div class="scan-page">
    <!-- Header -->
    <header class="scan-header">
        <h3>Smart Attendance Scan</h3>
        <p>Scan QR codes for automatic online/offline attendance recording</p>
        <div class="status-indicators">
            <div class="connection-indicator @(isOnline ? "online" : "offline")">
                <span class="status-icon">@(isOnline ? "üåê" : "üì¥")</span>
                <span class="status-text">@(isOnline ? "Online" : "Offline") Mode</span>
            </div>
        </div>
    </header>

    <!-- Main Scanner Area -->
    <main class="scanner-main">
        <div class="video-container">
            <MID_Nmiq_QrCode_Scanner @ref="qrScanner" 
                                     Width="100%" 
                                     Height="100%" 
                                     OnQrCodeDetected="OnQrCodeScanned" />
            
            <!-- Scan overlay frame -->
            <div class="scan-overlay">
                <div class="scan-frame">
                    <div class="frame-corners">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                    </div>
                    @if (isScanning && !isProcessing)
                    {
                        <div class="scan-line"></div>
                    }
                </div>
            </div>
        </div>

        <!-- Processing State -->
        @if (isProcessing)
        {
            <div class="processing-state">
                <div class="spinner"></div>
                <span>Processing QR Code...</span>
            </div>
        }

        <!-- Result overlay -->
        @if (showResult && !isProcessing)
        {
            <div class="result-overlay @(resultSuccess ? "success" : "error")">
                <div class="result-icon">
                    @if (resultSuccess)
                    {
                        <span class="success-icon">‚úì</span>
                    }
                    else
                    {
                        <span class="error-icon">‚úó</span>
                    }
                </div>
                <div class="result-message">@((MarkupString)resultMessage)</div>
                <button class="continue-btn" @onclick="ContinueScanning">Continue Scanning</button>
            </div>
        }
    </main>

    <!-- Controls and Status -->
    <footer class="scan-controls">
        <!-- Scanner Controls -->
        <div class="control-buttons">
            @if (isScanning)
            {
                <button class="control-btn stop" @onclick="StopScanning" disabled="@isProcessing">
                    <span class="icon">‚è∏</span>
                    Stop Scanner
                </button>
            }
            else
            {
                <button class="control-btn start" @onclick="StartScanning">
                    <span class="icon">‚ñ∂</span>
                    Start Scanner
                </button>
            }
            
            @if (isScanning)
            {
                <button class="control-btn camera" @onclick="SwitchCamera">
                    <span class="icon">üîÑ</span>
                    Switch Camera
                </button>
            }
        </div>

        <!-- Smart sync status panel -->
        <div class="sync-status-panel @(isOnline ? "online-mode" : "offline-mode")">
            <div class="status-header">
                <span class="status-icon">@(isOnline ? "‚ö°" : "üíæ")</span>
                <span>@(isOnline ? "Sync Status" : "Offline Records")</span>
            </div>
            
            <div class="status-info">
                <div class="status-item">
                    <span class="label">Connection:</span>
                    <span class="value @(isOnline ? "online-text" : "offline-text")">@(isOnline ? "‚úÖ Online" : "üì¥ Offline")</span>
                </div>
                
                <div class="status-item">
                    <span class="label">Pending Records:</span>
                    <span class="value @(pendingRecordsCount > 0 ? "has-pending" : "")">@pendingRecordsCount</span>
                </div>
                
                @if (lastSyncTime.HasValue)
                {
                    <div class="status-item">
                        <span class="label">Last Activity:</span>
                        <span class="value">@lastSyncTime.Value.ToString("HH:mm")</span>
                    </div>
                }
            </div>
            
            @if (pendingRecordsCount > 0 && isOnline)
            {
                <button class="sync-btn" @onclick="TrySync" disabled="@isSyncing">
                    @if (isSyncing)
                    {
                        <span class="spinner-small"></span>
                        <span>Syncing...</span>
                    }
                    else
                    {
                        <span>üîÑ Sync Now</span>
                    }
                </button>
            }
            else if (pendingRecordsCount > 0 && !isOnline)
            {
                <div class="sync-info">
                    <span class="info-icon">‚ÑπÔ∏è</span>
                    <span>Records will sync automatically when online</span>
                </div>
            }
            else if (pendingRecordsCount == 0 && isOnline)
            {
                <div class="sync-info success">
                    <span class="info-icon">‚úÖ</span>
                    <span>All records synced</span>
                </div>
            }
        </div>
    </footer>
</div>

<!-- Notification Component -->
<NotificationComponent @ref="notificationComponent" 
                      Position="NotificationPosition.TopRight" 
                      AutoDismissTime="4000" 
                      ShowProgressBar="true" 
                      ShowCloseButton="true" 
                      PauseOnHover="true" />
