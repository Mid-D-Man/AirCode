@page "/Client/Courses"
@using AirCode.Domain.Entities
@using AirCode.Domain.Enums
@using AirCode.Domain.ValueObjects
@using AirCode.Services.Courses
@using AirCode.Layout.AdminLayout.Superior
@using AirCode.Layout.FullScreen
@using AirCode.Utilities.ObjectPooling
@using AirCode.Components.SharedPrefabs.Popups
@using AirCode.Components.SharedPrefabs.Cards
@layout FullScreenLayout
@inject ICourseService CourseService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>My Course Management</PageTitle>

<div class="student-course-container">
    <div class="page-header">
        <div class="header-content">
            <h2 class="page-title">
                <i class="icon-books"></i>
                Course Management
            </h2>
            <div class="student-info">
                <span class="matric-number">@CurrentMatricNumber</span>
                <span class="level-badge level-@CurrentStudentLevel.ToString().ToLower()">
                    @GetLevelDisplay(CurrentStudentLevel)
                </span>
            </div>
        </div>
    </div>

    @if (IsLoading)
    {
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading your courses...</p>
    </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
    <div class="alert alert-error">
        <i class="icon-warning"></i>
        @ErrorMessage
    </div>
    }
    else
    {
    <div class="course-management-grid">
        <!-- Current Enrolled Courses -->
        <div class="enrolled-courses-section">
            <div class="section-header">
                <h3>My Enrolled Courses</h3>
                <span class="course-count">@GetEnrolledCoursesCount() Courses</span>
            </div>

            @if (CurrentStudentCourse?.StudentCoursesRefs?.Any() == true)
            {
            <div class="courses-grid">
                @foreach (var courseRef in GetEnrolledCoursesForCurrentPage())
                {
                var course = AvailableCourses.FirstOrDefault(c => c.CourseCode == courseRef.CourseCode);
                <div class="course-card enrolled-card status-@courseRef.CourseEnrollmentStatus.ToString().ToLower()">
                    @if (courseRef.CourseEnrollmentStatus == CourseEnrollmentStatus.Carryover)
                    {
                        <div class="carryover-banner">
                            Carryover
                        </div>
                    }
                    
                    <div class="course-header">
                        <h4 class="course-code">@courseRef.CourseCode</h4>
                        <div class="course-status">
                            <span class="status-badge status-@courseRef.CourseEnrollmentStatus.ToString().ToLower()">
                                @courseRef.CourseEnrollmentStatus
                            </span>
                        </div>
                    </div>

                    @if (course != null)
                    {
                    <div class="course-details">
                        <h5 class="course-name">@course.Name</h5>
                        <div class="course-info">
                            <span class="credit-units">@course.CreditUnits Units</span>
                            <span class="semester">@course.Semester Semester</span>
                        </div>

                        @if (course.Schedule.TimeSlots.Any() == true)
                        {
                        <div class="schedule-info">
                            @foreach (var slot in course.Schedule.TimeSlots.Take(2))
                            {
                            <div class="time-slot">
                                <span class="day">@slot.Day.ToString().Substring(0, 3)</span>
                                <span class="time">@slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm")</span>
                            </div>
                            }
                            @if (course.Schedule.TimeSlots.Count > 2)
                            {
                            <div class="more-schedule">+@(course.Schedule.TimeSlots.Count - 2) more</div>
                            }
                        </div>
                        }
                    </div>
                    }

                    <div class="course-dates">
                        <small class="enrollment-date">
                            Enrolled: @courseRef.EnrollmentDate.ToString("MMM dd, yyyy")
                        </small>
                        @if (courseRef.LastStatusChange != courseRef.EnrollmentDate)
                        {
                        <small class="status-change">
                            Updated: @courseRef.LastStatusChange.ToString("MMM dd, yyyy")
                        </small>
                        }
                    </div>

                    <div class="course-actions">
                        @if (courseRef.CourseEnrollmentStatus == CourseEnrollmentStatus.Enrolled)
                        {
                        <button class="btn btn-warning btn-sm"
                                @onclick="() => ShowDropConfirmation(courseRef.CourseCode)"
                                disabled="@IsProcessing">
                            Drop Course
                        </button>
                        }
                        else if (courseRef.CourseEnrollmentStatus == CourseEnrollmentStatus.Dropped)
                        {
                        <button class="btn btn-success btn-sm"
                                @onclick="() => ShowReenrollConfirmation(courseRef.CourseCode)"
                                disabled="@IsProcessing">
                            Re-enroll
                        </button>
                        }

                        <button class="btn btn-danger btn-sm"
                                @onclick="() => ShowRemoveConfirmation(courseRef.CourseCode)"
                                disabled="@IsProcessing">
                            Remove
                        </button>
                    </div>
                </div>
                }
            </div>

            <!-- Enrolled Courses Pagination -->
            @if (GetTotalEnrolledPages() > 1)
            {
                <div class="pagination-container">
                    <div class="pagination-info">
                        Page @_paginationState.StudentsCurrentPage of @GetTotalEnrolledPages()
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-outline btn-sm" 
                                @onclick="PreviousEnrolledPage" 
                                disabled="@(_paginationState.StudentsCurrentPage <= 1)">
                            ← Previous
                        </button>
                        <span class="page-indicator">
                            @_paginationState.StudentsCurrentPage / @GetTotalEnrolledPages()
                        </span>
                        <button class="btn btn-outline btn-sm" 
                                @onclick="NextEnrolledPage" 
                                disabled="@(_paginationState.StudentsCurrentPage >= GetTotalEnrolledPages())">
                            Next →
                        </button>
                    </div>
                </div>
            }
            }
            else
            {
            <div class="empty-state">
                <i class="icon-empty"></i>
                <h4>No Enrolled Courses</h4>
                <p>You haven't enrolled in any courses yet. Browse available courses to get started.</p>
            </div>
            }
        </div>

        <!-- Available Courses -->
        <div class="available-courses-section">
            <div class="section-header">
                <h3>Available Courses</h3>
                <div class="course-filters">
                    <select class="filter-select" @bind="SelectedSemester" @bind:after="OnSemesterFilterChanged">
                        <option value="">All Semesters</option>
                        <option value="@SemesterType.FirstSemester">First Semester</option>
                        <option value="@SemesterType.SecondSemester">Second Semester</option>
                    </select>
                    <input type="text" class="search-input" placeholder="Search courses..."
                           @bind="SearchTerm" @bind:after="OnSearchChanged" />
                </div>
            </div>

            <div class="courses-grid">
                @foreach (var course in FilteredCourses)
                {
                var isEnrolled = IsStudentEnrolledInCourse(course.CourseCode);
                <div class="course-card available-card @(isEnrolled ? "already-enrolled" : "")">
                    <div class="course-header">
                        <h4 class="course-code">@course.CourseCode</h4>
                        <span class="credit-units">@course.CreditUnits Units</span>
                    </div>

                    <div class="course-details">
                        <h5 class="course-name">@course.Name</h5>
                        <div class="course-info">
                            <span class="semester">@course.Semester Semester</span>
                            <span class="level">Level @course.Level.ToString().Replace("Level", "")</span>
                        </div>

                        @if (course.Schedule.TimeSlots?.Any() == true)
                        {
                        <div class="schedule-preview">
                            @foreach (var slot in course.Schedule.TimeSlots.Take(1))
                            {
                            <span class="schedule-item">
                                @slot.Day.ToString().Substring(0, 3)
                                @slot.StartTime.ToString(@"hh\:mm")-@slot.EndTime.ToString(@"hh\:mm")
                            </span>
                            }
                            @if (course.Schedule.TimeSlots.Count > 1)
                            {
                            <span class="more-schedule">+@(course.Schedule.TimeSlots.Count - 1) more</span>
                            }
                        </div>
                        }
                    </div>

                    <div class="course-actions">
                        @if (isEnrolled)
                        {
                        <span class="enrolled-indicator">
                            <i class="icon-check"></i> Already Enrolled
                        </span>
                        }
                        else
                        {
                        <button class="btn btn-primary"
                                @onclick="() => ShowEnrollConfirmation(course.CourseCode)"
                                disabled="@IsProcessing">
                            Enroll Now
                        </button>
                        }
                    </div>
                </div>
                }
            </div>

            <!-- Available Courses Pagination -->
            @if (GetTotalAvailablePages() > 1)
            {
                <div class="pagination-container">
                    <div class="pagination-info">
                        Page @_paginationState.CourseRepsCurrentPage of @GetTotalAvailablePages()
                        (@(GetTotalAvailablePages() * CoursesPerPage) total courses)
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-outline btn-sm" 
                                @onclick="PreviousPage" 
                                disabled="@(_paginationState.CourseRepsCurrentPage <= 1)">
                            ← Previous
                        </button>
                        
                        <!-- Page number buttons for quick navigation -->
                        @for (int i = Math.Max(1, _paginationState.CourseRepsCurrentPage - 2); 
                              i <= Math.Min(GetTotalAvailablePages(), _paginationState.CourseRepsCurrentPage + 2); 
                              i++)
                        {
                            var pageNum = i; // Capture for closure
                            <button class="btn @(_paginationState.CourseRepsCurrentPage == pageNum ? "btn-primary" : "btn-outline") btn-sm"
                                    @onclick="() => GoToPage(pageNum)">
                                @pageNum
                            </button>
                        }
                        
                        <button class="btn btn-outline btn-sm" 
                                @onclick="NextPage" 
                                disabled="@(_paginationState.CourseRepsCurrentPage >= GetTotalAvailablePages())">
                            Next →
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Course Statistics -->
    <div class="course-statistics">
        <div class="stat-card">
            <div class="stat-number">@GetEnrolledCoursesCount()</div>
            <div class="stat-label">Enrolled Courses</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">@GetTotalCreditUnits()</div>
            <div class="stat-label">Total Credit Units</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">@GetCarryoverCount()</div>
            <div class="stat-label">Carryover Courses</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">@GetDroppedCount()</div>
            <div class="stat-label">Dropped Courses</div>
        </div>
    </div>
    }
</div>

<!-- Confirmation Popup -->
<AreYouSurePopup IsVisible="@ShowConfirmPopup"
                 IsLoading="@IsProcessing"
                 Title="@ConfirmationTitle"
                 Message="@ConfirmationMessage"
                 WarningText="@ConfirmationWarning"
                 ConfirmButtonText="@ConfirmButtonText"
                 ConfirmButtonClass="@ConfirmButtonClass"
                 LoadingTitle="Processing..."
                 LoadingSubtitle="@LoadingMessage"
                 OnConfirm="HandleConfirmAction"
                 OnCancel="HideConfirmation" />

<!-- Notification Component -->
<NotificationComponent @ref="NotificationRef" />

@code {
    // Confirmation popup state
    private bool ShowConfirmPopup = false;
    private string ConfirmationTitle = "";
    private string ConfirmationMessage = "";
    private string ConfirmationWarning = "";
    private string ConfirmButtonText = "";
    private string ConfirmButtonClass = "";
    private string LoadingMessage = "";
    private string PendingCourseCode = "";
    private CourseAction PendingAction = CourseAction.None;
    private NotificationComponent? NotificationRef;

    private enum CourseAction
    {
        None,
        Enroll,
        Remove,
        Drop,
        Reenroll
    }

    // Confirmation methods
    private void ShowEnrollConfirmation(string courseCode)
    {
        var course = AvailableCourses.FirstOrDefault(c => c.CourseCode == courseCode);
        PendingCourseCode = courseCode;
        PendingAction = CourseAction.Enroll;
        
        ConfirmationTitle = "Confirm Enrollment";
        ConfirmationMessage = $"Are you sure you want to enroll in {courseCode}?";
        ConfirmationWarning = course != null ? $"This will add {course.CreditUnits} credit units to your current load." : "";
        ConfirmButtonText = "Enroll";
        ConfirmButtonClass = "btn-primary";
        LoadingMessage = "Enrolling you in the course...";
        
        ShowConfirmPopup = true;
    }

    private void ShowRemoveConfirmation(string courseCode)
    {
        PendingCourseCode = courseCode;
        PendingAction = CourseAction.Remove;
        
        ConfirmationTitle = "Remove Course";
        ConfirmationMessage = $"Are you sure you want to permanently remove {courseCode} from your course list?";
        ConfirmationWarning = "This action cannot be undone. You will need to re-enroll if you want to take this course again.";
        ConfirmButtonText = "Remove";
        ConfirmButtonClass = "btn-danger";
        LoadingMessage = "Removing course from your list...";
        
        ShowConfirmPopup = true;
    }

    private void ShowDropConfirmation(string courseCode)
    {
        PendingCourseCode = courseCode;
        PendingAction = CourseAction.Drop;
        
        ConfirmationTitle = "Drop Course";
        ConfirmationMessage = $"Are you sure you want to drop {courseCode}?";
        ConfirmationWarning = "You can re-enroll later, but this will affect your current course load.";
        ConfirmButtonText = "Drop";
        ConfirmButtonClass = "btn-warning";
        LoadingMessage = "Dropping course...";
        
        ShowConfirmPopup = true;
    }

    private void ShowReenrollConfirmation(string courseCode)
    {
        PendingCourseCode = courseCode;
        PendingAction = CourseAction.Reenroll;
        
        ConfirmationTitle = "Re-enroll in Course";
        ConfirmationMessage = $"Are you sure you want to re-enroll in {courseCode}?";
        ConfirmationWarning = "";
        ConfirmButtonText = "Re-enroll";
        ConfirmButtonClass = "btn-success";
        LoadingMessage = "Re-enrolling you in the course...";
        
        ShowConfirmPopup = true;
    }

    private void HideConfirmation()
    {
        ShowConfirmPopup = false;
        PendingCourseCode = "";
        PendingAction = CourseAction.None;
    }

    private async Task HandleConfirmAction()
{
    if (string.IsNullOrEmpty(PendingCourseCode) || PendingAction == CourseAction.None)
    {
        HideConfirmation();
        return;
    }

    try
    {
        // Set processing state BEFORE any async operations
        IsProcessing = true;
        StateHasChanged(); // Force UI update to show spinner

        bool success = false;
        string successMessage = "";

        switch (PendingAction)
        {
            case CourseAction.Enroll:
                success = await EnrollInCourse(PendingCourseCode);
                successMessage = $"Successfully enrolled in {PendingCourseCode}";
                break;
            case CourseAction.Remove:
                success = await RemoveCourse(PendingCourseCode);
                successMessage = $"Successfully removed {PendingCourseCode}";
                break;
            case CourseAction.Drop:
                success = await UpdateCourseStatus(PendingCourseCode, CourseEnrollmentStatus.Dropped);
                successMessage = $"Successfully dropped {PendingCourseCode}";
                break;
            case CourseAction.Reenroll:
                success = await UpdateCourseStatus(PendingCourseCode, CourseEnrollmentStatus.Enrolled);
                successMessage = $"Successfully re-enrolled in {PendingCourseCode}";
                break;
        }

        if (success && NotificationRef != null)
        {
            NotificationRef.ShowSuccess(successMessage, 3000); // 3 second duration
        }
    }
    finally
    {
        IsProcessing = false;
        HideConfirmation();
        StateHasChanged();
    }
}
}
