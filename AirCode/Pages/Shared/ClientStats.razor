@page "/Client/Stats"
@using AirCode.Layout.FullScreen
@using AirCode.Components.SharedPrefabs.Spinner
@using AirCode.Components.SharedPrefabs.Others
@layout FullScreenLayout
@inherits ClientStatsBase

<div class="client-stats-page">
    <div class="stats-header">
        <h2>My Attendance Statistics</h2>
        <p>Track your course attendance and performance for @CurrentStudentMatric</p>
    </div>

    @if (IsLoading)
    {
        <LoadingSpinner Title="Loading Statistics" Subtitle="Fetching your attendance data..." />
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="error-container">
            <div class="error-content">
                <div class="error-icon">
                    <i class="oi oi-warning"></i>
                </div>
                <h3>Unable to Load Statistics</h3>
                <p class="error-message">@ErrorMessage</p>
                <button @onclick="LoadDataAsync" class="retry-btn">
                    <i class="oi oi-refresh"></i>
                    Retry Loading
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Top Section: Quick Overview Stats -->
        <div class="stats-top-section">
            <div class="overview-cards">
                <div class="overview-card primary">
                    <div class="card-icon">
                        <i class="oi oi-person"></i>
                    </div>
                    <div class="card-content">
                        <h3>@GetLevelDisplay(CurrentStudentLevel)</h3>
                        <p>Current Level</p>
                        <small>@CurrentStudentMatric</small>
                    </div>
                </div>
                
                <div class="overview-card success">
                    <div class="card-icon">
                        <i class="oi oi-check"></i>
                    </div>
                    <div class="card-content">
                        <h3>@OverallAttendanceRate%</h3>
                        <p>Overall Attendance</p>
                        <small>@TotalClassesAttended/@TotalClasses Classes</small>
                    </div>
                </div>

                <div class="overview-card info">
                    <div class="card-icon">
                        <i class="oi oi-book"></i>
                    </div>
                    <div class="card-content">
                        <h3>@TotalEnrolledCourses</h3>
                        <p>Total Courses</p>
                        <small>@TotalCreditUnits Total CU</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Action Buttons -->
        <div class="stats-bottom-section">
            <div class="action-section">
                <h3>Detailed Statistics</h3>
                <p>Choose how you want to view your academic progress</p>
                
                <div class="action-buttons">
                    <button class="action-btn primary" @onclick="ShowOverallStats">
                        <div class="btn-icon">
                            <i class="oi oi-bar-chart"></i>
                        </div>
                        <div class="btn-content">
                            <h4>Overall Statistics</h4>
                            <p>View comprehensive attendance summary</p>
                            <div class="btn-stats">
                                <span class="stat-item">
                                    <i class="oi oi-book"></i>
                                    @TotalEnrolledCourses Courses
                                </span>
                                <span class="stat-item">
                                    <i class="oi oi-target"></i>
                                    @TotalCreditUnits CU Total
                                </span>
                                @if (TotalCarryOverCourses > 0)
                                {
                                    <span class="stat-item warning">
                                        <i class="oi oi-reload"></i>
                                        @TotalCarryOverCourses Carry Over
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="btn-arrow">
                            <i class="oi oi-chevron-right"></i>
                        </div>
                    </button>

                    <button class="action-btn secondary" @onclick="ShowCourseStats">
                        <div class="btn-icon">
                            <i class="oi oi-list"></i>
                        </div>
                        <div class="btn-content">
                            <h4>Course-Specific Stats</h4>
                            <p>Detailed breakdown by individual courses</p>
                            <div class="btn-stats">
                                <span class="stat-item">
                                    <i class="oi oi-check"></i>
                                    Individual tracking
                                </span>
                                <span class="stat-item">
                                    <i class="oi oi-calendar"></i>
                                    Attendance records
                                </span>
                            </div>
                        </div>
                        <div class="btn-arrow">
                            <i class="oi oi-chevron-right"></i>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<!-- Overall Stats Modal -->
@if (ShowOverallStatsModal)
{
    <GlobalBackdrop />
    <div class="stats-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Overall Statistics Summary</h2>
                <button class="close-btn" @onclick="CloseOverallStats">
                    <i class="oi oi-x"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="overall-stats-grid">
                    <div class="stat-card total-courses">
                        <div class="card-header">
                            <i class="oi oi-book"></i>
                            <h4>Course Enrollment</h4>
                        </div>
                        <div class="stat-details">
                            <div class="primary-stat">@TotalEnrolledCourses</div>
                            <div class="stat-label">Total Courses</div>
                            <div class="secondary-stats">
                                <div class="secondary-stat">
                                    <span class="value">@TotalCreditUnits</span>
                                    <span class="label">Credit Units</span>
                                </div>
                                @if (TotalCarryOverCourses > 0)
                                {
                                    <div class="secondary-stat warning">
                                        <span class="value">@TotalCarryOverCourses</span>
                                        <span class="label">Carry Over</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="stat-card attendance-summary">
                        <div class="card-header">
                            <i class="oi oi-check"></i>
                            <h4>Attendance Summary</h4>
                        </div>
                        <div class="stat-details">
                            <div class="attendance-circle @GetAttendanceClass(OverallAttendanceRate)">
                                <div class="percentage">@OverallAttendanceRate%</div>
                                <div class="circle-label">Overall Rate</div>
                            </div>
                            <div class="attendance-breakdown">
                                <div class="breakdown-item">
                                    <span class="label">Classes Attended:</span>
                                    <span class="value">@TotalClassesAttended</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="label">Total Classes:</span>
                                    <span class="value">@TotalClasses</span>
                                </div>
                                <div class="breakdown-item">
                                    <span class="label">Classes Missed:</span>
                                    <span class="value">@(TotalClasses - TotalClassesAttended)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Course-Specific Stats Modal -->
@if (ShowCourseStatsModal)
{
    <GlobalBackdrop />
    <div class="stats-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Course-Specific Statistics</h2>
                <button class="close-btn" @onclick="CloseCourseStats">
                    <i class="oi oi-x"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="courses-section">
                    <div class="section-header">
                        <div class="course-filters">
                            <select @bind="SelectedSemesterFilter" @bind:after="FilterCourses" class="filter-select">
                                <option value="">All Semesters</option>
                                <option value="First">First Semester</option>
                                <option value="Second">Second Semester</option>
                            </select>
                            <select @bind="SelectedStatusFilter" @bind:after="FilterCourses" class="filter-select">
                                <option value="">All Status</option>
                                <option value="Enrolled">Enrolled</option>
                                <option value="Carryover">Carry Over</option>
                            </select>
                        </div>
                    </div>
                    
                    @if (FilteredCourseStats?.Any() == true)
                    {
                        <div class="courses-grid">
                            @foreach (var courseStats in FilteredCourseStats)
                            {
                                <div class="course-stats-card @(courseStats.IsCarryOver ? "carry-over" : "")" 
                                     @onclick="() => HandleCourseStatsClick(courseStats)">
                                    <div class="course-header">
                                        <div class="course-title">
                                            <h4>@courseStats.CourseName</h4>
                                            <span class="course-code">@courseStats.CourseCode</span>
                                        </div>
                                        <div class="course-badges">
                                            @if (courseStats.IsCarryOver)
                                            {
                                                <span class="carry-over-badge">Carry Over</span>
                                            }
                                            <span class="attendance-badge @GetAttendanceClass(courseStats.AttendancePercentage)">
                                                @GetAttendanceLabel(courseStats.AttendancePercentage)
                                            </span>
                                        </div>
                                    </div>

                                    <div class="course-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Attendance Rate</span>
                                            <div class="progress-container">
                                                <div class="progress-bar">
                                                    <div class="progress @GetAttendanceClass(courseStats.AttendancePercentage)" 
                                                         style="width: @(courseStats.AttendancePercentage)%"></div>
                                                </div>
                                                <span class="stat-value">@(courseStats.AttendancePercentage)%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="course-quick-stats">
                                            <div class="quick-stat">
                                                <span class="value">@(courseStats.ClassesAttended)/@(courseStats.TotalClasses)</span>
                                                <span class="label">Classes</span>
                                            </div>
                                            <div class="quick-stat">
                                                <span class="value">@courseStats.CreditUnits</span>
                                                <span class="label">CU</span>
                                            </div>
                                            <div class="quick-stat">
                                                <span class="value">@courseStats.TotalAbsences</span>
                                                <span class="label">Absences</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-courses">
                            <div class="no-courses-icon">
                                <i class="oi oi-book"></i>
                            </div>
                            <h4>No Courses Found</h4>
                            <p>@(string.IsNullOrEmpty(SelectedSemesterFilter) && string.IsNullOrEmpty(SelectedStatusFilter) 
                                ? "You are not enrolled in any courses yet." 
                                : "No courses match your current filters.")</p>
                            @if (!string.IsNullOrEmpty(SelectedSemesterFilter) || !string.IsNullOrEmpty(SelectedStatusFilter))
                            {
                                <button @onclick="ClearFilters" class="clear-filters-btn">
                                    <i class="oi oi-x"></i>
                                    Clear Filters
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
