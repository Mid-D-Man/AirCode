@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Rendering
@using AirCode.Services.Permissions
@using Microsoft.AspNetCore.Components.Routing;
@inherits ComponentBase
@implements IComponent
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager

@if (IsLoading)
{
    <div class="auth-loading">
        <p>Loading...</p>
    </div>
}
else if (Authorized)
{
    <RouteView RouteData="@RouteData" DefaultLayout="@DefaultLayout" />
}
else if (IsRedirecting)
{
    <div class="auth-loading">
        <p>Redirecting...</p>
    </div>
}
else
{
    <div class="unauthorized-access">
        <h3>Access Denied</h3>
        <p>You don't have permission to access this page.</p>
        <button class="btn btn-primary" @onclick="() => NavigationManager.NavigateTo('/'.ToString())">
            Return Home
        </button>
    </div>
}

@code {
    [Parameter] public RouteData RouteData { get; set; } = default!;
    [Parameter] public Type? DefaultLayout { get; set; }
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }
    
    private bool Authorized { get; set; }
    private bool IsRedirecting { get; set; }
    private bool IsLoading { get; set; } = true;

   protected override async Task OnInitializedAsync()
{
    MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] URI: {NavigationManager.Uri}", DebugClass.Info);
    MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] Page Type: {RouteData?.PageType?.Name}", DebugClass.Info);

    var currentPath = new Uri(NavigationManager.Uri).AbsolutePath;
    MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] Current Path: {currentPath}", DebugClass.Info);

    if (currentPath == "/" || currentPath == "/AirCode/" || currentPath.EndsWith("/index") ||
        RouteData?.PageType?.Name == "Index")
    {
        MID_HelperFunctions.DebugMessage("[AuthorizeRouteView] Index page detected - allowing access", DebugClass.Info);
        Authorized = true;
        IsLoading = false;
        StateHasChanged();
        return;
    }

    MID_HelperFunctions.DebugMessage("[AuthorizeRouteView] Not index page - checking authentication", DebugClass.Info);

    if (AuthenticationState == null)
    {
        MID_HelperFunctions.DebugMessage("[AuthorizeRouteView] AuthenticationState is null", DebugClass.Warning);
        Authorized = false;
        IsLoading = false;
        StateHasChanged();
        return;
    }

    try
    {
        var authState = await AuthenticationState;
        var user = authState.User;
        MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] User authenticated: {user?.Identity?.IsAuthenticated}", DebugClass.Info);

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            MID_HelperFunctions.DebugMessage("[AuthorizeRouteView] User not authenticated - redirecting to login", DebugClass.Warning);
            IsRedirecting = true;
            IsLoading = false;
            StateHasChanged();

            var returnUrl = Uri.EscapeDataString(NavigationManager.Uri);
            NavigationManager.NavigateTo($"authentication/login?returnUrl={returnUrl}");
            return;
        }

        MID_HelperFunctions.DebugMessage("[AuthorizeRouteView] Checking authorization", DebugClass.Info);
        Authorized = await CheckAuthorizationAsync(user);
        MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] Authorization result: {Authorized}", DebugClass.Info);
    }
    catch (Exception ex)
    {
        MID_HelperFunctions.DebugMessage($"[AuthorizeRouteView] Error during auth check: {ex.Message}", DebugClass.Exception);
        Authorized = false;
    }
    finally
    {
        IsLoading = false;
        StateHasChanged();
    }
}

    private async Task<bool> CheckAuthorizationAsync(ClaimsPrincipal user)
    {
        var authorizeAttribute = RouteData.PageType
            .GetCustomAttributes(typeof(AuthorizeAttribute), true)
            .Cast<AuthorizeAttribute>()
            .FirstOrDefault();

        if (authorizeAttribute == null) return true;

        // Check roles
        if (!string.IsNullOrEmpty(authorizeAttribute.Roles))
        {
            var roles = authorizeAttribute.Roles.Split(',')
                .Select(r => r.Trim())
                .ToArray();

            return roles.Any(role => user.IsInRole(role));
        }

        // Check policies
        if (!string.IsNullOrEmpty(authorizeAttribute.Policy))
        {
            return await CheckPolicyAsync(user, authorizeAttribute.Policy);
        }

        return user.Identity.IsAuthenticated;
    }

    private async Task<bool> CheckPolicyAsync(ClaimsPrincipal user, string policy)
    {
        var userId = user.FindFirst("sub")?.Value ?? user.FindFirst("id")?.Value;
        if (string.IsNullOrEmpty(userId)) return false;

        return policy switch
        {
            "SuperiorAdmin" => user.IsInRole("superioradmin"),
            "LecturerAdmin" => user.IsInRole("lectureradmin"),
            "CourseAdmin" => user.IsInRole("courserepadmin"),
            "AnyAdmin" => user.IsInRole("superioradmin") || user.IsInRole("lectureradmin") || user.IsInRole("courserepadmin"),
            "Student" => user.IsInRole("student"),
            _ => true
        };
    }
}