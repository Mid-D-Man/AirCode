@using AirCode.Domain.Entities
@using AirCode.Services.Courses
@using AirCode.Components.SharedPrefabs.Cards
@using AirCode.Components.SharedPrefabs.Spinner
@using AirCode.Domain.Enums
@inject ICourseService CourseService

<div class="course-management-container">
    <!-- Assigned Courses List -->
    <div class="assigned-courses-section">
        <h3>@SectionTitle</h3>

        @if (AssignedCourses?.Any() == true)
        {
            @foreach (var course in AssignedCourses)
            {
                <div class="course-item">
                    <div class="course-info">
                        <div class="course-primary">
                            <span class="course-code">@course.CourseCode</span>
                            <span class="course-name">@course.Name</span>
                        </div>
                        <div class="course-details">
                            <span>@course.DepartmentId</span>
                            <span>@course.CreditUnits units</span>
                            <span>Level @((int)course.Level + 100)</span>
                        </div>
                    </div>
                    <button class="btn-remove"
                            @onclick="() => ShowRemoveConfirmation(course.CourseCode, course.Name)"
                            disabled="@IsLoading"
                            title="Remove @course.CourseCode">
                        @if (IsLoading && _loadingCourseCode == course.CourseCode)
                        {
                            <div class="loading-spinner"></div>
                        }
                        else
                        {
                            <i class="fas fa-trash-alt"></i>
                            <span class="btn-text">Remove</span>
                        }
                    </button>
                </div>
            }
        }
        else
        {
            <div class="no-courses">
                <i class="fas fa-book" style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-tertiary);"></i>
                <p>No courses assigned yet.</p>
            </div>
        }
    </div>

    <!-- Add Course Button -->
    <div class="add-course-section">
        <button class="btn-add-course" @onclick="ShowAddCourseModal" disabled="@IsLoading">
            @if (IsLoading && _loadingCourseCode == null)
            {
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            }
            else
            {
                <i class="fas fa-plus"></i>
                <span>@AddButtonText</span>
            }
        </button>
    </div>

    <!-- Add Course Modal -->
    @if (ShowModal)
    {
        <div class="modal-overlay @(ShowModal ? "visible" : "")" @onclick="HideAddCourseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h4>
                        <i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: var(--primary-600);"></i>
                        Select Course to Add
                    </h4>
                    <button class="btn-close" @onclick="HideAddCourseModal">&times;</button>
                </div>

                <div class="modal-body">
                    @if (IsLoadingCourses)
                    {
                        <div class="loading-container">
                            <LoadingSpinner Title="Loading Courses" 
                                          Subtitle="Fetching available courses..." />
                        </div>
                    }
                    else if (AvailableCourses?.Any() == true)
                    {
                        <div class="search-box">
                            <input type="text" @bind="SearchTerm" @oninput="FilterCourses"
                                   placeholder="ðŸ” Search by course code, name, or department..." 
                                   class="search-input" />
                        </div>

                        <div class="course-list">
                            @if (FilteredCourses?.Any() == true)
                            {
                                @foreach (var course in FilteredCourses)
                                {
                                    <div class="selectable-course-item" @onclick="() => ShowAddConfirmation(course.CourseCode, course.Name)">
                                        <div class="course-info">
                                            <div class="course-primary">
                                                <span class="course-code">@course.CourseCode</span>
                                                <span class="course-name">@course.Name</span>
                                            </div>
                                            <div class="course-details">
                                                <span>@course.DepartmentId</span>
                                                <span>Level @((int)course.Level + 100)</span>
                                                <span>@course.CreditUnits units</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-results">
                                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>No courses match your search criteria.</p>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-results">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No available courses found.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Confirmation Dialogs -->
    @if (ShowAddConfirmationDialog)
    {
        <div class="modal-overlay visible">
            <div class="confirmation-dialog">
                <h4>
                    <i class="fas fa-plus-circle" style="color: var(--success); margin-right: 0.5rem;"></i>
                    Confirm Add Course
                </h4>
                <p>Are you sure you want to add <strong>@_confirmationCourseName (@_confirmationCourseCode)</strong>?</p>
                <div
