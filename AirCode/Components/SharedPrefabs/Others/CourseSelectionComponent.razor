@using AirCode.Domain.Entities
@using AirCode.Domain.Enums
@using AirCode.Services.Courses
@using AirCode.Components.SharedPrefabs.Spinner
@using AirCode.Services.VisualElements
@inject ICourseService CourseService
@inject IBackdropService BackdropService
@inject IJSRuntime JSRuntime

@if (IsVisible)
{
    <!-- Course Selection for attendance events -->
    <div id="course-selection-modal-@InstanceId" 
         class="modal-overlay @(IsVisible ? "visible" : "")" 
         @onclick="HandleBackdropClick"
         @ref="modalOverlayRef">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: var(--primary-600);"></i>
                    Select Course
                </h3>
                <button class="close-btn" @onclick="CloseModal">&times;</button>
            </div>

            <div class="modal-body">
                <div class="search-container">
                    <input type="text"
                           @bind="SearchTerm"
                           @oninput="OnSearchChanged"
                           placeholder="ðŸ” Search by course code, name, or department..."
                           class="search-input" />
                </div>

                <div class="filters-container">
                    <select value="@SelectedDepartment" 
                            @onchange="OnDepartmentChanged" 
                            class="filter-select">
                        <option value="">All Departments</option>
                        @foreach (var dept in AvailableDepartments)
                        {
                            <option value="@dept">@dept</option>
                        }
                    </select>

                    <select value="@SelectedLevel" 
                            @onchange="OnLevelChanged" 
                            class="filter-select">
                        <option value="">All Levels</option>
                        @foreach (LevelType level in Enum.GetValues<LevelType>())
                        {
                            <option value="@level">Level @GetLevelDisplay(level)</option>
                        }
                    </select>

                    <select value="@SelectedSemester" 
                            @onchange="OnSemesterChanged" 
                            class="filter-select">
                        <option value="">All Semesters</option>
                        @foreach (SemesterType semester in Enum.GetValues<SemesterType>())
                        {
                            <option value="@semester">@semester.ToString().Replace("Semester", " Semester")</option>
                        }
                    </select>
                </div>

                <div class="courses-list">
                    @if (IsLoadingCourses)
                    {
                        <div class="loading-indicator">
                            <LoadingSpinner Title="Loading Courses" 
                                          Subtitle="Fetching available courses..." />
                        </div>
                    }
                    else if (FilteredCourses?.Any() == true)
                    {
                        @foreach (var course in FilteredCourses.Take(50))
                        {
                            <div class="course-item @(SelectedCourse?.CourseCode == course.CourseCode ? "selected" : "")"
                                 @onclick="() => SelectCourse(course)">
                                <div class="course-header">
                                    <span class="course-code">@course.CourseCode</span>
                                    <span class="course-level">Level @GetLevelDisplay(course.Level)</span>
                                </div>
                                <div class="course-name">@course.Name</div>
                                <div class="course-details">
                                    <span class="department">@course.DepartmentId</span>
                                    <span class="credits">@course.CreditUnits CU</span>
                                    <span class="semester">@course.Semester.ToString().Replace("Semester", "S")</span>
                                </div>
                                @if (course.Schedule.TimeSlots?.Any() == true)
                                {
                                    <div class="course-schedule">
                                        <small>@course.Schedule.FormatSchedule()</small>
                                    </div>
                                }
                            </div>
                        }

                        @if (FilteredCourses.Count > 50)
                        {
                            <div class="more-results">
                                Showing 50 of @FilteredCourses.Count results. Please refine your search.
                            </div>
                        }
                    }
                    else
                    {
                        <div class="no-results">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No courses found matching your criteria</p>
                        </div>
                    }
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn-primary"
                        @onclick="ConfirmSelection"
                        disabled="@(SelectedCourse == null || IsLoading)">
                    @if (IsLoading)
                    {
                        <LoadingSpinner Title="" Subtitle="" />
                    }
                    else
                    {
                        <i class="fas fa-check"></i>
                    }
                    Select Course
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<Course> OnCourseSelected { get; set; }
    [Parameter] public EventCallback OnClosed { get; set; }
    [Parameter] public bool IsOfflineMode { get; set; }

    private List<Course> AllCourses = new();
    private List<Course> FilteredCourses = new();
    private List<string> AvailableDepartments = new();

    private string SearchTerm = "";
    private string SelectedDepartment = "";
    private LevelType? SelectedLevel = null;
    private SemesterType? SelectedSemester = null;

    private Course SelectedCourse;
    private bool IsLoadingCourses = false;
    private bool IsLoading = false;
    private Timer _debounceTimer;
    
    // Portal management
    private ElementReference modalOverlayRef;
    private string InstanceId = Guid.NewGuid().ToString("N")[..8];
    private string ModalSelector => $"#course-selection-modal-{InstanceId}";
    private bool _isInPortal = false;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !_wasVisible)
        {
            await ShowModalAsync();
        }
        else if (!IsVisible && _wasVisible)
        {
            await HideModalAsync();
        }

        _wasVisible = IsVisible;

        if (IsVisible)
        {
            IsLoadingCourses = true;
            StateHasChanged();

            try
            {
                AllCourses = IsOfflineMode
                    ? await LoadOfflineCoursesAsync()
                    : await CourseService.GetAllCoursesAsync();

                AvailableDepartments = AllCourses
                    .Where(c => !string.IsNullOrEmpty(c.DepartmentId))
                    .Select(c => c.DepartmentId)
                    .Distinct()
                    .OrderBy(d => d)
                    .ToList();

                FilterCourses();
            }
            catch (Exception ex)
            {
                await MID_HelperFunctions.DebugMessageAsync($"Error loading courses: {ex.Message}", DebugClass.Exception);
            }
            finally
            {
                IsLoadingCourses = false;
                StateHasChanged();
            }
        }
    }
    
    private bool _wasVisible = false;

    private async Task ShowModalAsync()
    {
        try
        {
            // Give the DOM time to render
            await Task.Delay(50);
            await BackdropService.MoveElementToPortalAsync(ModalSelector);
            _isInPortal = true;
        }
        catch (Exception ex)
        {
            await MID_HelperFunctions.DebugMessageAsync($"Error showing modal: {ex.Message}", DebugClass.Exception);
        }
    }

    private async Task HideModalAsync()
    {
        try
        {
            if (_isInPortal)
            {
                await BackdropService.ReturnElementFromPortalAsync(ModalSelector);
                _isInPortal = false;
            }
        }
        catch (Exception ex)
        {
            await MID_HelperFunctions.DebugMessageAsync($"Error hiding modal: {ex.Message}", DebugClass.Exception);
        }
    }

    // Rest of your existing methods stay the same...
    private string GetLevelDisplay(LevelType level)
    {
        return level switch
        {
            LevelType.Level100 => "100",
            LevelType.Level200 => "200",
            LevelType.Level300 => "300",
            LevelType.Level400 => "400",
            LevelType.Level500 => "500",
            LevelType.LevelExtra => "Extra",
            _ => "Unknown"
        };
    }
    private async Task<List<Course>> LoadOfflineCoursesAsync()
    {
        try
        {
            var courses = await CourseService.GetCoursesFromLocalStorageAsync();
            if (courses == null || !courses.Any())
            {
                await MID_HelperFunctions.DebugMessageAsync("No courses found in local storage.", DebugClass.Warning);
                return new List<Course>();
            }
            return courses;
        }
        catch (Exception ex)
        {
            await MID_HelperFunctions.DebugMessageAsync($"Error loading offline courses: {ex.Message}", DebugClass.Exception);
            return new List<Course>();
        }
    }
    private async Task LoadCourses()
    {
        IsLoadingCourses = true;
        StateHasChanged();

        try
        {
            var courses = await CourseService.GetAllCoursesAsync();
            AllCourses = courses ?? new List<Course>();

            AvailableDepartments = AllCourses
                .Where(c => !string.IsNullOrEmpty(c.DepartmentId))
                .Select(c => c.DepartmentId)
                .Distinct()
                .OrderBy(d => d)
                .ToList();

            FilterCourses();
        }
        catch (Exception ex)
        {
            await MID_HelperFunctions.DebugMessageAsync($"Error loading courses: {ex.Message}", DebugClass.Exception);
            AllCourses = new List<Course>();
            FilteredCourses = new List<Course>();
        }
        finally
        {
            IsLoadingCourses = false;
            StateHasChanged();
        }
    }

    private void FilterCourses()
    {
        if (!AllCourses.Any())
        {
            FilteredCourses = new List<Course>();
            return;
        }

        FilteredCourses = AllCourses.Where(course =>
            {
                if (!string.IsNullOrWhiteSpace(SearchTerm))
                {
                    var query = SearchTerm.ToLowerInvariant();
                    if (!course.CourseCode.ToLowerInvariant().Contains(query) &&
                        !course.Name.ToLowerInvariant().Contains(query) &&
                        !course.DepartmentId.ToLowerInvariant().Contains(query))
                    {
                        return false;
                    }
                }

                if (!string.IsNullOrEmpty(SelectedDepartment) &&
                    course.DepartmentId != SelectedDepartment)
                {
                    return false;
                }

                if (SelectedLevel.HasValue && course.Level != SelectedLevel.Value)
                {
                    return false;
                }

                if (SelectedSemester.HasValue && course.Semester != SelectedSemester.Value)
                {
                    return false;
                }

                return true;
            })
            .OrderBy(c => c.CourseCode)
            .ToList();

        StateHasChanged();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        SearchTerm = e.Value?.ToString() ?? "";
        
        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(_ => InvokeAsync(() =>
        {
            FilterCourses();
            StateHasChanged();
        }), null, 300, Timeout.Infinite);
    }

    private async Task OnDepartmentChanged(ChangeEventArgs e)
    {
        SelectedDepartment = e.Value?.ToString() ?? "";
        FilterCourses();
    }

    private async Task OnLevelChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        SelectedLevel = string.IsNullOrEmpty(value) || !Enum.TryParse<LevelType>(value, out var level) 
            ? (LevelType?)null 
            : level;
        FilterCourses();
    }

    private async Task OnSemesterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        SelectedSemester = string.IsNullOrEmpty(value) || !Enum.TryParse<SemesterType>(value, out var semester) 
            ? (SemesterType?)null 
            : semester;
        FilterCourses();
    }

    private void SelectCourse(Course course)
    {
        SelectedCourse = course;
        StateHasChanged();
    }

    private async Task ConfirmSelection()
    {
        if (SelectedCourse != null)
        {
            IsLoading = true;
            StateHasChanged();

            try
            {
                await OnCourseSelected.InvokeAsync(SelectedCourse);
                await CloseModal();
            }
            catch (Exception ex)
            {
                await MID_HelperFunctions.DebugMessageAsync($"Error selecting course: {ex.Message}", DebugClass.Exception);
            }
            finally
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    private void HandleBackdropClick()
    {
        if (!IsLoading && !IsLoadingCourses)
        {
            _ = CloseModal();
        }
    }

    private async Task CloseModal()
    {
        // Return from portal before closing
        await HideModalAsync();
        
        // Reset all state
        SelectedCourse = null;
        SearchTerm = "";
        SelectedDepartment = "";
        SelectedLevel = null;
        SelectedSemester = null;
        
        _debounceTimer?.Dispose();
        _debounceTimer = null;

        await OnClosed.InvokeAsync();
    }

    public async void Dispose()
    {
        _debounceTimer?.Dispose();

        // Ensure we return from portal on disposal
        if (_isInPortal)
        {
            try
            {
                await BackdropService.ReturnElementFromPortalAsync(ModalSelector);
            }
            catch (Exception ex)
            {
                await MID_HelperFunctions.DebugMessageAsync($"Error during disposal: {ex.Message}", DebugClass.Exception);
            }
        }
    }
}